.wrapper
  .sidebar
    .geocoder
      form class="row no-margin-right"
        .col-sm-10.no-padding-right
          input type="texbox" class="form-control" placeholder="福岡県飯塚市"
        .col-sm-2.no-padding-left
          input class="btn btn-default" type="button" value="検索"

    h1 サンプル
    h1 福岡県福岡市博多区

    p   人口<span style="margin-right: 2em;"></span>232,795人
    p   男女比<span style="margin-right: 2em;"></span>5:5
    p   年齢比
    
    .age-ratio
      table
        thead
          tr
            td.text-right 10代以下
            td 11%
          tr
            td.text-right 20代
            td 12%
          tr
            td.text-right 30代
            td 15%
          tr
            td.text-right 40代
            td 17%
          tr
            td.text-right 50代
            td 20%
          tr
            td.text-right 60代以上
            td 25%

    .row
      .col-sm-8.col-md-offset-2
        input type="text" class="form-control input-sm" placeholder="キーワードで絞り込む"

    / input style="margin-top: 20px; margin-left: 20px; margin-bottom: 10px; width: 150px;" placeholder='キーワードで絞り込む'
    / ul style='list-style: none; color: white; padding: 0; margin-left: 15px; margin-top: 0px;'
    .label 
      h2 カテゴリ

    .category
      table
        thead
          - @categories.each do |category|
            tr
              td
                input type='checkbox' value="category.id"
              td = category.NAME

  input id='token' type='hidden' value='#{form_authenticity_token}'
  .mapview
    #map style="width: 100%; height: 100%;"
      - if user_signed_in?
        javascript:
          last_LATITUDE = #{if @last then @last["LATITUDE"] else 0};
          last_LONGITUDE =  #{if @last then @last["LONGITUDE"] else 0};
          
          var tokenDOM = document.getElementById("token");
          token = tokenDOM.value;
          var geocoder = new google.maps.Geocoder();
            
          handler = Gmaps.build('Google');
          handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
            markers = handler.addMarkers(#{raw @hash.to_json});
            handler.bounds.extendWith(markers);
            handler.fitMapToBounds();
            if (last_LATITUDE == 0 && last_LONGITUDE == 0){
              handler.getMap().setCenter(new google.maps.LatLng(36.204824, 138.252924)); 
              handler.getMap().setZoom(5);
            }
            else{
              handler.getMap().setCenter(new google.maps.LatLng(last_LATITUDE, last_LONGITUDE)); 
              handler.getMap().setZoom(16);
            }
          });

          handler.callback = function(){
            google.maps.event.addListener(handler.map.serviceObject, "click", function(e){
              var form = '<form class="new_wants" id="new_wants" action="/wants" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="'+token+'" /><div class="field"><input type="hidden" name="wants[USER_ID]" value="'+#{if current_user then current_user.id}+'"  id="wants_USER_ID" /></div><div class="field"><label for="wants_TITLE">Title</label><input type="text" name="wants[TITLE]" id="wants_TITLE" />が欲しい！</div><div class="field"><label for="wants_CATEGORY_ID">Category name</label><select id="categories_id" name="wants[CATEGORY_ID]" id="wants_CATEGORY_ID" />i<option value="1">飲食関係</option><option value="2">ファッション</option><option value="3">エンタメ</option><option value="4">公共施設</option><option value="5">交通関係</option></select></div><div class="field"><label for="wants_COMMENT">Comment</label><textarea name="wants[COMMENT]" id="wants_COMMENT"></textarea></div><div class="field"><input type="hidden" name="wants[LATITUDE]" value="'+e.latLng.lat()+'"  id="wants_LATITUDE" /></div><div class="field"><input type="hidden" name="wants[LONGITUDE]" value="'+e.latLng.lng()+'"  id="wants_LONGITUDE" /></div><div class="actions"><input type="submit" name="commit" value="Create Wants" data-disable-with="Create Wants" /></div></form>';
              markers = handler.addMarkers([
                {
                  "lat": e.latLng.lat(),
                  "lng": e.latLng.lng(),
                  "infowindow": form,
                }
              ]);
            });
            
            document.getElementById('submit').addEventListener('click', function() {
              geocodeAddress(geocoder, handler);
            });

            function geocodeAddress(geocoder, resultMap) {
              var address = document.getElementById('address').value;
              geocoder.geocode({'address': address}, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                  resultMap.getMap().setCenter(results[0].geometry.location);
                  resultMap.getMap().setZoom(17);
                } else {
                  alert('Geocode was not successful for the following reason: ' + status);
                }
              });
            }
          }();

      - else
        javascript:
          var tokenDOM = document.getElementById("token");
          token = tokenDOM.value;
          var geocoder = new google.maps.Geocoder();

          handler = Gmaps.build('Google');
          handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
            markers = handler.addMarkers(#{raw @hash.to_json});
            handler.getMap().setCenter(new google.maps.LatLng(36.204824, 138.252924));
            handler.getMap().setZoom(5);
            handler.bounds.extendWith(markers);
            handler.fitMapToBounds();
          });

          handler.callback = function(){
            google.maps.event.addListener(handler.map.serviceObject, "click", function(e){
              var form = 'ピンを建てるには'+'<a href="/users/sign_in">ログイン</a>'+'か'+'<a href="/users/sign_up">新規登録</a>'+'を行ってください'
              markers = handler.addMarkers([
                {
                  "lat": e.latLng.lat(),
                  "lng": e.latLng.lng(),
                  "infowindow": form,
                }
              ]);
            });

            document.getElementById('submit').addEventListener('click', function() {
              geocodeAddress(geocoder, handler);
            });

            function geocodeAddress(geocoder, resultMap) {
              var address = document.getElementById('address').value;
              geocoder.geocode({'address': address}, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                  resultMap.getMap().setCenter(results[0].geometry.location);
                  resultMap.getMap().setZoom(17);
                } else {
                  alert('Geocode was not successful for the following reason: ' + status);
                }
              });
            }
          }();

